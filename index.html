<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆæˆå¤§è¥¿ç“œ - é›²ç«¯æ’è¡Œæ¦œç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #ffe4b5; font-family: 'Arial', sans-serif; touch-action: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        canvas { box-shadow: 0 0 20px rgba(0,0,0,0.2); background-color: #fffaf0; }
        .score-board { position: absolute; top: 20px; left: 20px; font-size: 24px; font-weight: bold; color: #5d4037; background: rgba(255,255,255,0.7); padding: 10px 20px; border-radius: 20px; }
        .nav-buttons { position: absolute; bottom: 30px; display: flex; gap: 15px; }
        .btn { padding: 12px 25px; font-size: 18px; border: none; border-radius: 25px; cursor: pointer; color: white; text-decoration: none; font-weight: bold; transition: transform 0.2s; }
        .btn-leaderboard { background-color: #ff9800; box-shadow: 0 4px #e65100; }
        .btn-leaderboard:active { transform: translateY(4px); box-shadow: 0 0 #e65100; }
    </style>
</head>
<body>

<div id="game-container">
    <div class="score-board">åˆ†æ•¸: <span id="score">0</span></div>
    
    <div class="nav-buttons">
        <a href="leaderboard.html" class="btn btn-leaderboard">ğŸ† æŸ¥çœ‹å…¨çƒæ’è¡Œ</a>
    </div>
</div>

<script>
    // --- éŠæˆ²åƒæ•¸èˆ‡åˆå§‹åŒ– ---
    const { Engine, Render, Runner, Bodies, Composite, Events, Body } = Matter;
    const engine = Engine.create();
    const world = engine.world;
    
    const container = document.getElementById('game-container');
    const width = Math.min(window.innerWidth, 450);
    const height = window.innerHeight;
    let score = 0;
    let isGameOver = false;

    const render = Render.create({
        element: container,
        engine: engine,
        options: { width, height, wireframes: false, background: '#fffaf0' }
    });

    // --- æ°´æœè¨­å®š (ç­‰ç´šèˆ‡é¡è‰²) ---
    const FRUIT_CONFIG = [
        { radius: 15, label: 'ğŸ’', score: 2, color: '#ff5252' },
        { radius: 25, label: 'ğŸ“', score: 4, color: '#ff4081' },
        { radius: 35, label: 'ğŸ‡', score: 8, color: '#7e57c2' },
        { radius: 45, label: 'ğŸŠ', score: 16, color: '#ffb74d' },
        { radius: 55, label: 'ğŸ', score: 32, color: '#ef5350' },
        { radius: 70, label: 'ğŸ‘', score: 64, color: '#ffab91' },
        { radius: 85, label: 'ğŸ', score: 128, color: '#fff176' },
        { radius: 100, label: 'ğŸˆ', score: 256, color: '#aed581' },
        { radius: 120, label: 'ğŸ‰', score: 512, color: '#4caf50' }
    ];

    // --- é‚Šç•Œè¨­å®š ---
    const ground = Bodies.rectangle(width / 2, height + 10, width, 60, { isStatic: true });
    const leftWall = Bodies.rectangle(-10, height / 2, 20, height, { isStatic: true });
    const rightWall = Bodies.rectangle(width + 10, height / 2, 20, height, { isStatic: true });
    Composite.add(world, [ground, leftWall, rightWall]);

    // --- ç”Ÿæˆæ°´æœé‚è¼¯ ---
    let currentFruit = null;
    function createFruit(x, y, level, isStatic = false) {
        const config = FRUIT_CONFIG[level];
        const fruit = Bodies.circle(x, y, config.radius, {
            label: 'fruit_' + level,
            restitution: 0.3,
            friction: 0.1,
            isStatic: isStatic,
            render: { fillStyle: config.color }
        });
        fruit.level = level;
        return fruit;
    }

    function spawnNewFruit() {
        if (isGameOver) return;
        const level = Math.floor(Math.random() * 3); // åˆå§‹éš¨æ©Ÿç”Ÿå‰ä¸‰ç­‰æ°´æœ
        currentFruit = createFruit(width / 2, 50, level, true);
        Composite.add(world, currentFruit);
    }

    // --- æ»‘é¼ /è§¸æ§äº‹ä»¶ ---
    window.addEventListener('mousedown', (e) => {
        if (!currentFruit || isGameOver) return;
        Body.setStatic(currentFruit, false);
        currentFruit = null;
        setTimeout(spawnNewFruit, 1000);
    });

    window.addEventListener('mousemove', (e) => {
        if (currentFruit && !isGameOver) {
            const x = e.clientX - container.offsetLeft;
            Body.setPosition(currentFruit, { x: Math.max(20, Math.min(width - 20, x)), y: 50 });
        }
    });

    // --- ç¢°æ’åˆä½µé‚è¼¯ ---
    Events.on(engine, 'collisionStart', (event) => {
        event.pairs.forEach((pair) => {
            const { bodyA, bodyB } = pair;
            if (bodyA.label.startsWith('fruit_') && bodyA.label === bodyB.label) {
                const level = bodyA.level;
                if (level < FRUIT_CONFIG.length - 1) {
                    const newX = (bodyA.position.x + bodyB.position.x) / 2;
                    const newY = (bodyA.position.y + bodyB.position.y) / 2;
                    
                    score += FRUIT_CONFIG[level].score;
                    document.getElementById('score').innerText = score;

                    Composite.remove(world, [bodyA, bodyB]);
                    Composite.add(world, createFruit(newX, newY, level + 1));
                }
            }
        });
    });

    // --- éŠæˆ²çµæŸæª¢æŸ¥ ---
    Events.on(engine, 'afterUpdate', () => {
        if (isGameOver) return;
        world.bodies.forEach(body => {
            if (!body.isStatic && body.position.y < 80 && body !== currentFruit) {
                gameOver();
            }
        });
    });

    function gameOver() {
        isGameOver = true;
        alert("éŠæˆ²çµæŸï¼ç¸½åˆ†: " + score);
        
        // è‡ªå‹•è©¢å•ç©å®¶å§“åä¸¦ä¸Šå‚³åˆ†æ•¸
        const name = prompt("è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±ä»¥è¨˜éŒ„è‡³æ’è¡Œæ¦œ:", "ç©å®¶");
        if (name) {
            uploadScore(name, score);
        }
    }

    // --- ä¸Šå‚³åˆ†æ•¸è‡³ Google Script API ---
    function uploadScore(name, score) {
        const API_URL = "https://script.google.com/macros/s/AKfycbywXhhgL-HKpir9nrWZ2JXTy6mzy2a2aqJoUvss8z-LTQTmTg8SdHz4jnq5uJUCXq9lEQ/exec";
        
        // ä½¿ç”¨ JSONP æˆ–ç„¡è·³è½‰æ–¹å¼é€å‡ºè³‡æ–™
        const url = `${API_URL}?action=addScore&name=${encodeURIComponent(name)}&score=${score}`;
        
        fetch(url, { mode: 'no-cors' }) // ä½¿ç”¨ no-cors é¿å…è·¨ç¶²åŸŸæ””æˆª
            .then(() => {
                alert("åˆ†æ•¸ä¸Šå‚³æˆåŠŸï¼");
                window.location.href = "leaderboard.html"; // è·³è½‰è‡³æ’è¡Œæ¦œ
            })
            .catch(err => console.error("ä¸Šå‚³å¤±æ•—:", err));
    }

    // å•Ÿå‹•éŠæˆ²
    Render.run(render);
    const runner = Runner.create();
    Runner.run(runner, engine);
    spawnNewFruit();

</script>
</body>
</html>
